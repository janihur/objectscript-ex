/// <p>A simple demo application illustrating basic IPM functionality.</p>
/// <example>
/// set demo = ##class(OSEX.ipm.demo.Main).%New()
/// do demo.Config("OSEX.ipm.numbers.Random", 100)
/// do demo.Run()
/// </example>
Class OSEX.ipm.demo.Main Extends %RegisteredObject
{

Property numberGenerator [ Private ];

Method %OnNew() As %Status
{
	#dim numberGenerator as %String = $get(^OSEX.ipm.demo("settings", "numberGenerator"))
	if (numberGenerator '= "") {
		set ..numberGenerator = ..createNumberGenerator(numberGenerator)
	}
	return $$$OK
}

Method SetNumberGenerator(
	numberGenerator As %String,
	args...)
{
	set ..numberGenerator = ..createNumberGenerator(numberGenerator, args...)
}

ClassMethod SetDefaultName(name As %String)
{
	if (name '= "") {
		set ^OSEX.ipm.demo("settings", "defaultName") = name
	} else {
		kill ^OSEX.ipm.demo("settings", "defaultName")
	}
}

ClassMethod createNumberGenerator(
	numberGenerator As %String,
	args...) [ Private ]
{
	try {
		return $classmethod(numberGenerator, "%New", args...)
	} catch ex {
		write "Error: ", "Number generator creation failure: ", numberGenerator, !
		write "Error: ", ex.DisplayString(), !
		return $$$NULLOREF
	}
}

Method Run(name As %String = "")
{
	if (name = "") {
		set name = $get(^OSEX.ipm.demo("settings", "defaultName"), "World")
	}

	write ##class(OSEX.ipm.hello.Hello).Hello(name),!
	
	if ($isobject(..numberGenerator)) {
		#dim n as %Integer = 0
		#dim text as %String = ""
		if (..numberGenerator.%IsA("OSEX.ipm.numbers.Random")) {
			set n = ..numberGenerator.Rand()
			set text = "random"
		}elseif (..numberGenerator.%IsA("OSEX.ipm.numbers.Fibonacci")) {
			#dim nth as %Integer = ##class(OSEX.ipm.numbers.Random).%New(100).Rand()
			set n = ..numberGenerator.Fib(nth)
			set text = "Fibonacci"
		}else {
			// unsupported number generator
			set text = "default"
		}
		write "Your number is ", n, ". Generated by ", text, " number generator.", !
	}
}

}
